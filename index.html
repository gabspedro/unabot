const API_BASE = "http://localhost:8000";

const chatBox = document.querySelector(".chat-box");
const chatMode = document.getElementById("chat-mode");
const questionInput = document.getElementById("questionInput");
const urlInput = document.getElementById("urlInput");
const fileInput = document.getElementById("fileInput");
const fileBtn = document.getElementById("fileBtn");
const sendBtn = document.getElementById("sendBtn");

// Adiciona mensagem ao chat
function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.classList.add("chat-message", sender === "user" ? "chat-user" : "chat-bot");
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Envia a mensagem com base no modo
async function sendMessage() {
  const mode = chatMode.value;
  const question = questionInput.value.trim();

  if (!question) return;

  addMessage(question, "user");
  questionInput.value = "";

  // Mensagem temporÃ¡ria
  const thinkingMsg = document.createElement("div");
  thinkingMsg.classList.add("chat-message", "chat-bot");
  thinkingMsg.textContent = "Pensando...";
  chatBox.appendChild(thinkingMsg);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    let resposta;

    if (mode === "1") {
      // PadrÃ£o
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      const data = await res.json();
      resposta = data.resposta;

    } else if (mode === "2") {
      // URL
      const url = urlInput.value.trim();
      if (!url) return alert("Insira uma URL vÃ¡lida.");
      const res = await fetch(`${API_BASE}/chat/url`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url, question })
      });
      const data = await res.json();
      resposta = data.resposta;

    } else if (mode === "3") {
      // Arquivo PDF
      const file = fileInput.files[0];
      if (!file) return alert("Selecione um arquivo PDF.");
      const formData = new FormData();
      formData.append("file", file);
      formData.append("question", question);
      const res = await fetch(`${API_BASE}/chat/file`, {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      resposta = data.resposta;
    }

    thinkingMsg.remove();
    addMessage(resposta ?? "Sem resposta", "bot");

  } catch (err) {
    thinkingMsg.remove();
    addMessage("Erro ao conectar com o servidor.", "bot");
  }
}

// BotÃ£o de enviar
sendBtn.addEventListener("click", sendMessage);

// Enter envia tambÃ©m
questionInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

// BotÃ£o ðŸ“Ž ativa seletor de PDF
fileBtn.addEventListener("click", () => {
  if (chatMode.value === "3") {
    fileInput.click();
  } else {
    alert("Esse botÃ£o serve para enviar PDF. Selecione o modo 'ARQUIVO'.");
  }
});

// Mostrar nome do arquivo selecionado
fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) {
    const fileName = fileInput.files[0].name;
    addMessage(`ðŸ“Ž Arquivo selecionado: ${fileName}`, "user");
  }
});

// Exibir/ocultar campos adicionais com base no modo
chatMode.addEventListener("change", () => {
  urlInput.classList.add("d-none");
  fileInput.classList.add("d-none");

  if (chatMode.value === "2") {
    urlInput.classList.remove("d-none");
  } else if (chatMode.value === "3") {
    fileInput.classList.remove("d-none");
  }
});
